# commentery of environment-variables in c
コードを書いてみて分かったことを、ざっくりまとめていきます。

## 調査環境
念のため、ウチイダの環境を記載しておきます。
- Host OS: Windows 10 Pro 20H2 build 19042.844
- WSL: ver2
- Guset OS: Ubuntu 20.04.1 LTS (Focal Fossa)
- compiler: gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)

## mainの第三引数から、環境変数を受け取ることができる
argvの後ろに、`char *envp[]` という形で環境変数を取得することができます。  
全く知らなかった…  
ただし、main関数の第三引数は標準規格ではないらしく、`extern char **envion` を関数内で宣言するほうがよいようです。
情報元は[こちら](http://www.kouno.jp/home/c_faq/c11.html#13)

## argv と environ は末尾にNULLポインタが付けられている
コマンドライン引数を表す文字列の配列 `*argv[]` は、与えられた引数を順番に配列に含めています。  
そして、終端の目印としてNULLを最後につけています。そのため、argv[argc] は必ずNULLです。  
これは、環境変数の内容を与えられている `**environ` も同様です。  
"KEY=vlaue" の形式で文字列データとして配列内に並べられていて、終端にNULLが付けられています。

## argv と environ はメモリ上で隣接している
試してみて驚きましたが、スタックフレームの構造を考えてみたら、そういうものなのかなあと思いました。  
`argv[argc]` が NULLになっているのは上記の通りですが、 `argv[argc + 1]` は `environ[0]` です。  
親プロセスからプログラムを呼び出す際、おそらくスタック領域に値を保存しているんですね。
この辺は、もしかしたらコンパイラ(gcc)の仕様かもしれませんが…

## 親プロセスのenviron と、子プロセスのenviron は別のアドレスを参照している
当たり前と言えば当たり前なのですが。  
環境変数の仕様として、親プロセスから子プロセスに複製され、子プロセスでの変更は親プロセスに影響しない、ということになっています。  
親プロセスの環境変数に、子プロセスからアクセスできないようにしておくほうがよいのでしょう。  
親プロセスで`extern **environ` を通じて得られるアドレスと、子プロセスでのそれは別のものになっています。

## プログラム内で追加された環境変数は、ヒープ領域に保存される
上記の通りの挙動のため、プログラム内で追加された環境変数の項目は、スタック領域に追加することができません。  
そのため、`setenv()` や `putenv()` を実行した際には、`malloc()` などで確保した領域に KEY=valueの値を保存します。
さらに**environのポインタも、配列の長さ+1して確保しなおして、末尾に新しい環境変数の項目を追加します。  
プログラム起動時にもともと設定されていた項目はスタック領域に、プログラム内で追加された項目はヒープ領域に存在する、という状態になります。

## 蛇足①：プログラム起動時の環境変数の内容は、procディレクトリ内にファイルとして保持されている
`/proc/[pid]/` は、そのプロセスに関する情報がたくさん含まれているディレクトリです。  
この中の`envrion` というファイルには、プログラム起動時の環境変数の一覧が記載されています。  
ただし、このファイルに記載されるのは「プロセスが作られたときに、OSから渡された環境変数」のみです。  
プログラムによって追加された環境変数は、ここには反映されません。

## 蛇足：シェル変数も環境変数も、shell内部では同じ
環境変数のほかに、ターミナルのプロンプトから設定できる変数（シェル変数）があります。  
子プロセス生成時に引き継がれず、宣言されたプロセス内でスコープが閉じている変数です。  
じつは、bashの実装では、環境変数とシェル変数は同じ構造体で管理されているのだそうです。  

## まとめ
普段何気なく使っている環境変数。調べてみると、知らなかったことがたくさんありますね…  
もっと深く理解する必要があるので、ひきつづき調査をしていきます。  
新しい知見があれば、また追記します。

## 参考ページ
- (Man page of ENVIRON)[https://linuxjm.osdn.jp/html/LDP_man-pages/man7/environ.7.html]
- (Language C FAQ (Japanese))[http://www.kouno.jp/home/c_faq/c0.html]
- (環境変数ってなに? \( Linux \))[https://qiita.com/angel_p_57/items/480e3fd4552e52199835]
- (原理原則で理解するbashの仕組み)[https://qiita.com/tajima_taso/items/149ca77a2401bf9bf026]